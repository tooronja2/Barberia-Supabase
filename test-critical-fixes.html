<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® TEST CR√çTICO - Correcciones Horarios y Duraciones</title>
    <link rel="stylesheet" href="css/style.css?v=20250704-6">
    <style>
        .critical-test {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }
        .test-critical-section {
            background: linear-gradient(145deg, #1a1a1a 0%, #2a2a2a 100%);
            margin-bottom: 3rem;
            padding: 3rem;
            border-radius: 12px;
            border: 2px solid #d4af37;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .critical-alert {
            background: linear-gradient(45deg, #e53e3e, #fc8181);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            font-weight: 600;
        }
        .fix-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        .fix-item:last-child {
            border-bottom: none;
        }
        .status-critical {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .status-fixed { background: linear-gradient(45deg, #38a169, #68d391); color: white; }
        .status-pending { background: linear-gradient(45deg, #e53e3e, #fc8181); color: white; }
        .status-testing { background: linear-gradient(45deg, #d4af37, #f4e4bc); color: #0a0a0a; }
        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .time-slot {
            padding: 0.5rem;
            background: #2a2a2a;
            border: 1px solid #d4af37;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8rem;
            color: #b8b8b8;
        }
        .time-slot.occupied {
            background: #e53e3e;
            color: white;
        }
        .time-slot.available {
            background: #38a169;
            color: white;
        }
        .duration-visual {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 0 0.25rem;
        }
        .duration-15 { background: #38a169; color: white; }
        .duration-30 { background: #d4af37; color: #0a0a0a; }
        .console-critical {
            background: #0a0a0a;
            color: #68d391;
            padding: 1.5rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 2rem;
            border: 1px solid #d4af37;
        }
    </style>
</head>
<body>
    <div class="critical-test">
        <h1 style="text-align: center; color: #e53e3e; font-size: 3.5rem; font-weight: 700; margin-bottom: 1rem;">
            üö® CORRECCIONES CR√çTICAS
        </h1>
        <p style="text-align: center; color: #b8b8b8; font-size: 1.2rem; margin-bottom: 3rem;">
            Testing de bugs cr√≠ticos en horarios y duraciones
        </p>
        
        <!-- Critical Alert -->
        <div class="critical-alert">
            <strong>‚ö†Ô∏è PROBLEMAS CR√çTICOS IDENTIFICADOS:</strong>
            <br>‚Ä¢ Intervalos de horarios incorrectos (30min ‚Üí 15min)
            <br>‚Ä¢ Duraciones hardcodeadas (debe ser din√°mico desde Supabase)
            <br>‚Ä¢ Algoritmo de bloqueo incorrecto (no considera slots m√∫ltiples)
        </div>
        
        <!-- Fix 1: Intervalos de Horarios -->
        <div class="test-critical-section">
            <h2 style="color: #d4af37; font-size: 2.5rem; margin-bottom: 2rem;">
                üïí FIX 1: INTERVALOS CADA 15 MINUTOS
            </h2>
            
            <div class="fix-item">
                <span><strong>Antes:</strong> 09:00, 09:30, 10:00, 10:30</span>
                <span class="status-critical status-pending">INCORRECTO</span>
            </div>
            <div class="fix-item">
                <span><strong>Despu√©s:</strong> 09:00, 09:15, 09:30, 09:45</span>
                <span class="status-critical status-fixed">CORREGIDO</span>
            </div>
            
            <h3 style="color: #d4af37; margin: 2rem 0 1rem;">‚úÖ Horarios Generados (Ma√±ana):</h3>
            <div class="time-grid" id="morning-slots">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <h3 style="color: #d4af37; margin: 2rem 0 1rem;">‚úÖ Horarios Generados (Tarde):</h3>
            <div class="time-grid" id="afternoon-slots">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Fix 2: Duraciones Din√°micas -->
        <div class="test-critical-section">
            <h2 style="color: #d4af37; font-size: 2.5rem; margin-bottom: 2rem;">
                üìä FIX 2: DURACIONES DIN√ÅMICAS
            </h2>
            
            <div class="fix-item">
                <span><strong>Problema:</strong> Textos hardcodeados en HTML</span>
                <span class="status-critical status-fixed">CORREGIDO</span>
            </div>
            <div class="fix-item">
                <span><strong>Soluci√≥n:</strong> Carga din√°mica desde Supabase</span>
                <span class="status-critical status-fixed">IMPLEMENTADO</span>
            </div>
            
            <h3 style="color: #d4af37; margin: 2rem 0 1rem;">üéØ Duraciones Correctas:</h3>
            <div style="padding: 1.5rem; background: #0a0a0a; border-radius: 8px;">
                <p><strong>Servicios de 15 minutos:</strong></p>
                <span class="duration-visual duration-15">Corte de barba</span>
                <span class="duration-visual duration-15">Corte de pelo</span>
                <span class="duration-visual duration-15">Corte todo m√°quina</span>
                
                <p style="margin-top: 1rem;"><strong>Servicios de 30 minutos:</strong></p>
                <span class="duration-visual duration-30">Corte de pelo y barba</span>
                <span class="duration-visual duration-30">Dise√±os y dibujos</span>
            </div>
        </div>
        
        <!-- Fix 3: Algoritmo de Bloqueo -->
        <div class="test-critical-section">
            <h2 style="color: #d4af37; font-size: 2.5rem; margin-bottom: 2rem;">
                üîí FIX 3: ALGORITMO DE BLOQUEO MEJORADO
            </h2>
            
            <div class="fix-item">
                <span><strong>Antes:</strong> Solo verificaba 1 slot</span>
                <span class="status-critical status-pending">INCORRECTO</span>
            </div>
            <div class="fix-item">
                <span><strong>Despu√©s:</strong> Verifica TODOS los slots necesarios</span>
                <span class="status-critical status-fixed">CORREGIDO</span>
            </div>
            
            <h3 style="color: #d4af37; margin: 2rem 0 1rem;">üí° Ejemplo de Bloqueo (Servicio 30min a las 09:00):</h3>
            <div style="padding: 1.5rem; background: #0a0a0a; border-radius: 8px;">
                <div class="time-grid">
                    <div class="time-slot occupied">09:00<br><small>OCUPADO</small></div>
                    <div class="time-slot occupied">09:15<br><small>OCUPADO</small></div>
                    <div class="time-slot available">09:30<br><small>LIBRE</small></div>
                    <div class="time-slot available">09:45<br><small>LIBRE</small></div>
                    <div class="time-slot available">10:00<br><small>LIBRE</small></div>
                </div>
                <p style="margin-top: 1rem; color: #b8b8b8;">
                    <strong>‚úÖ L√≥gica:</strong> Servicio de 30min bloquea 2 slots consecutivos (09:00 y 09:15)
                </p>
            </div>
        </div>
        
        <!-- Fix 4: Testing de Sincronizaci√≥n -->
        <div class="test-critical-section">
            <h2 style="color: #d4af37; font-size: 2.5rem; margin-bottom: 2rem;">
                üîÑ FIX 4: SINCRONIZACI√ìN AUTOM√ÅTICA
            </h2>
            
            <div class="fix-item">
                <span><strong>Test:</strong> Cambio en Supabase ‚Üí Frontend actualiza</span>
                <span class="status-critical status-testing" id="sync-status">PROBANDO</span>
            </div>
            
            <button onclick="testSupabaseSync()" class="step-button" style="margin: 1rem 0;">
                üß™ Probar Sincronizaci√≥n
            </button>
            
            <div id="sync-results" style="margin-top: 1rem; color: #b8b8b8;">
                Haz clic en "Probar Sincronizaci√≥n" para verificar que los cambios en Supabase se reflejen autom√°ticamente.
            </div>
        </div>
        
        <!-- Console de Debugging -->
        <div class="test-critical-section">
            <h2 style="color: #d4af37; font-size: 2.5rem; margin-bottom: 2rem;">
                üêõ CONSOLE DE DEBUGGING
            </h2>
            <div class="console-critical" id="debug-console">
                üöÄ Sistema de debugging iniciado...<br>
                üìã Verificando correcciones cr√≠ticas...<br>
            </div>
        </div>
        
        <!-- Botones de navegaci√≥n -->
        <div style="text-align: center; margin-top: 3rem;">
            <a href="reserva.html" class="step-button" style="margin: 0 1rem; text-decoration: none;">
                üìÖ Probar Reservas CORREGIDAS
            </a>
            <a href="index.html" class="step-button" style="margin: 0 1rem; text-decoration: none;">
                üè† Ver P√°gina Principal
            </a>
        </div>
    </div>
    
    <script type="module">
        // Import database functions
        import { db } from './js/supabase.js';
        
        // Console override
        const debugConsole = document.getElementById('debug-console');
        const originalLog = console.log;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            debugConsole.innerHTML += `<span style="color: #68d391">[${new Date().toLocaleTimeString()}]</span> ${args.join(' ')}<br>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
        };
        
        // Generate time slots for visualization
        function generateTimeSlots() {
            const morningGrid = document.getElementById('morning-slots');
            const afternoonGrid = document.getElementById('afternoon-slots');
            
            // Morning slots (9:00 - 11:45)
            const morningSlots = [];
            for (let hour = 9; hour < 12; hour++) {
                morningSlots.push(`${hour.toString().padStart(2, '0')}:00`);
                morningSlots.push(`${hour.toString().padStart(2, '0')}:15`);
                morningSlots.push(`${hour.toString().padStart(2, '0')}:30`);
                morningSlots.push(`${hour.toString().padStart(2, '0')}:45`);
            }
            
            morningGrid.innerHTML = morningSlots.map(slot => 
                `<div class="time-slot available">${slot}</div>`
            ).join('');
            
            // Afternoon slots (14:00 - 18:45)
            const afternoonSlots = [];
            for (let hour = 14; hour < 19; hour++) {
                afternoonSlots.push(`${hour.toString().padStart(2, '0')}:00`);
                afternoonSlots.push(`${hour.toString().padStart(2, '0')}:15`);
                afternoonSlots.push(`${hour.toString().padStart(2, '0')}:30`);
                afternoonSlots.push(`${hour.toString().padStart(2, '0')}:45`);
            }
            
            afternoonGrid.innerHTML = afternoonSlots.map(slot => 
                `<div class="time-slot available">${slot}</div>`
            ).join('');
            
            console.log(`‚úÖ Intervalos generados cada 15 minutos`);
            console.log(`üìä Ma√±ana: ${morningSlots.length} slots`, morningSlots);
            console.log(`üìä Tarde: ${afternoonSlots.length} slots`, afternoonSlots);
        }
        
        // Test Supabase synchronization
        window.testSupabaseSync = async function() {
            const syncStatus = document.getElementById('sync-status');
            const syncResults = document.getElementById('sync-results');
            
            syncStatus.textContent = 'PROBANDO';
            syncStatus.className = 'status-critical status-testing';
            
            try {
                console.log('üß™ TESTING: Cargando servicios desde Supabase...');
                const services = await db.getServices();
                
                if (services && services.length > 0) {
                    console.log('‚úÖ SUPABASE CONNECTED: Servicios cargados exitosamente');
                    console.log('üìä Servicios obtenidos:', services.map(s => `${s.name}: ${s.duration_minutes}min`));
                    
                    let allCorrect = true;
                    const expectedDurations = {
                        'Corte de barba': 15,
                        'Corte de pelo': 15,
                        'Corte todo m√°quina': 15,
                        'Corte de pelo y barba': 30,
                        'Dise√±os y dibujos': 30
                    };
                    
                    let results = '<h4 style="color: #d4af37;">üìä Verificaci√≥n de Duraciones:</h4><ul>';
                    
                    services.forEach(service => {
                        const expected = expectedDurations[service.name];
                        const actual = service.duration_minutes;
                        const correct = expected === actual;
                        
                        if (!correct) allCorrect = false;
                        
                        const icon = correct ? '‚úÖ' : '‚ùå';
                        const color = correct ? '#68d391' : '#fc8181';
                        
                        results += `<li style="color: ${color}">${icon} ${service.name}: ${actual}min ${correct ? '(CORRECTO)' : `(ESPERADO: ${expected}min)`}</li>`;
                        console.log(`${icon} ${service.name}: ${actual}min ${correct ? 'CORRECTO' : `INCORRECTO (esperado: ${expected}min)`}`);
                    });
                    
                    results += '</ul>';
                    
                    if (allCorrect) {
                        syncStatus.textContent = 'SINCRONIZADO';
                        syncStatus.className = 'status-critical status-fixed';
                        results += '<p style="color: #68d391; font-weight: 600;">‚úÖ TODAS LAS DURACIONES SON CORRECTAS</p>';
                        console.log('üéâ SYNC TEST PASSED: Todas las duraciones son correctas');
                    } else {
                        syncStatus.textContent = 'NECESITA CORRECCI√ìN';
                        syncStatus.className = 'status-critical status-pending';
                        results += '<p style="color: #fc8181; font-weight: 600;">‚ùå ALGUNAS DURACIONES NECESITAN CORRECCI√ìN EN SUPABASE</p>';
                        console.log('üö® SYNC TEST FAILED: Algunas duraciones son incorrectas');
                    }
                    
                    syncResults.innerHTML = results;
                    
                } else {
                    throw new Error('No se pudieron cargar servicios');
                }
                
            } catch (error) {
                console.log('‚ùå SYNC ERROR:', error.message);
                syncStatus.textContent = 'ERROR';
                syncStatus.className = 'status-critical status-pending';
                syncResults.innerHTML = `<p style="color: #fc8181;">‚ùå Error: ${error.message}</p>`;
            }
        };
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üö® TESTING CR√çTICO INICIADO');
            console.log('üîß Verificando correcciones implementadas...');
            
            generateTimeSlots();
            
            console.log('üìã RESUMEN DE CORRECCIONES:');
            console.log('‚úÖ 1. Intervalos cada 15 minutos (implementado)');
            console.log('‚úÖ 2. Textos din√°micos desde Supabase (implementado)');
            console.log('‚úÖ 3. Algoritmo de bloqueo mejorado (implementado)');
            console.log('üß™ 4. Probando sincronizaci√≥n autom√°tica...');
            
            // Auto-test sync after 2 seconds
            setTimeout(() => {
                window.testSupabaseSync();
            }, 2000);
        });
    </script>
</body>
</html>